<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom I2C Communication</title>
  <link rel="stylesheet" href="../static/style.css">
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: linear-gradient(90deg, #8A2BE2, #4169E1);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .back-button {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .back-button:hover {
      background: rgba(255,255,255,0.3);
    }
    .main-container {
      display: flex;
      flex: 1;
      gap: 15px;
      padding: 15px;
      overflow: hidden;
    }
    .settings-panel {
      flex: 0 0 400px;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
    }
    .settings-panel h2 {
      margin-top: 0;
      color: #8A2BE2;
      font-size: 1.4rem;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      margin-bottom: 5px;
      color: #aaaaaa;
      font-size: 0.9rem;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #8A2BE2;
      border-radius: 6px;
      color: #ffffff;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #da70d6;
    }
    .operation-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    .op-button {
      background: linear-gradient(135deg, #8a2be2, #da70d6);
      border: none;
      padding: 12px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    .op-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(138,43,226,0.5);
    }
    .op-button:active {
      transform: translateY(0);
    }
    .output-panel {
      flex: 1;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .output-panel h2 {
      margin-top: 0;
      color: #8A2BE2;
      font-size: 1.4rem;
    }
    #i2cOutput {
      flex: 1;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      color: #00ff00;
    }
    .control-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    .clear-button {
      background: linear-gradient(135deg, #666, #888);
      border: none;
      padding: 10px 25px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }
    .clear-button:hover {
      background: linear-gradient(135deg, #444, #666);
    }
    .info-box {
      background: #1a1a1a;
      border-left: 4px solid #8A2BE2;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Custom I2C Communication</h1>
    <button class="back-button" onclick="window.location.href='homepage.html'">‚Üê Back to Home</button>
  </div>
  
  <div class="main-container">
    <div class="settings-panel">
      <h2>I2C Configuration</h2>
      
      <div class="info-box">
        <strong>I2C Pins:</strong> GPIO 2 (SDA), GPIO 3 (SCL)
      </div>
      
      <div class="form-group">
        <label class="form-label">I2C Bus</label>
        <select id="bus" class="form-select">
          <option value="1" selected>Bus 1 (Default)</option>
          <option value="0">Bus 0</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Device Address (Hex)</label>
        <input type="text" id="address" class="form-input" value="0x48" placeholder="0x48">
      </div>
      
      <div class="form-group">
        <label class="form-label">Register Address (Hex)</label>
        <input type="text" id="register" class="form-input" value="0x00" placeholder="0x00">
      </div>
      
      <div class="form-group">
        <label class="form-label">Data to Write (Hex)</label>
        <input type="text" id="data" class="form-input" value="0xFF" placeholder="0xFF or 0x01,0x02,0x03">
      </div>
      
      <div class="form-group">
        <label class="form-label">Read Length (bytes)</label>
        <input type="number" id="length" class="form-input" value="1" min="1" max="32">
      </div>
      
      <div class="operation-buttons">
        <button class="op-button" onclick="showConfirmModal('scan')">Scan Bus</button>
        <button class="op-button" onclick="showConfirmModal('write_byte')">Write Byte</button>
        <button class="op-button" onclick="showConfirmModal('read_byte')">Read Byte</button>
        <button class="op-button" onclick="showConfirmModal('write_byte_data')">Write Register</button>
        <button class="op-button" onclick="showConfirmModal('read_byte_data')">Read Register</button>
        <button class="op-button" onclick="showConfirmModal('write_block')">Write Block</button>
        <button class="op-button" onclick="showConfirmModal('read_block')">Read Block</button>
      </div>
    </div>
    
    <div class="output-panel">
      <h2>Output Log</h2>
      <div id="i2cOutput">Ready to communicate via I2C...\nConfigure settings and select an operation.\n</div>
      <div class="control-buttons">
        <button class="clear-button" onclick="clearOutput()">Clear Log</button>
        <button class="clear-button" onclick="cleanupI2C()">Cleanup I2C</button>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); margin: 10% auto; padding: 0; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(138,43,226,0.5);">
      <div class="modal-header" style="background: linear-gradient(90deg, #8A2BE2, #4169E1); padding: 25px; border-radius: 20px 20px 0 0; text-align: center;">
        <h2 style="margin: 0; font-size: 1.5rem;">Confirm I2C Operation</h2>
      </div>
      <div class="modal-body" style="padding: 30px;">
        <p><strong>Operation:</strong> <span id="modalOperation"></span></p>
        <hr style="border-color: #555; margin: 15px 0;">
        <p><strong>Configuration:</strong></p>
        <p style="margin-left: 15px;">Bus: <span id="modalBus"></span></p>
        <p style="margin-left: 15px;">Device Address: <span id="modalAddress"></span></p>
        <p style="margin-left: 15px;" id="modalRegisterP">Register: <span id="modalRegister"></span></p>
        <p style="margin-left: 15px;" id="modalDataP">Data: <span id="modalData"></span></p>
        <p style="margin-left: 15px;" id="modalLengthP">Length: <span id="modalLength"></span> bytes</p>
      </div>
      <div class="modal-buttons" style="padding: 0 30px 30px; display: flex; gap: 15px;">
        <button class="modal-btn confirm" onclick="confirmAndRun()" style="flex: 1; background: linear-gradient(135deg, #8a2be2, #da70d6); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 1rem; transition: all 0.3s;">Confirm & Run</button>
        <button class="modal-btn cancel" onclick="closeModal()" style="flex: 1; background: linear-gradient(135deg, #555, #777); border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer; font-size: 1rem; transition: all 0.3s;">Edit Settings</button>
      </div>
    </div>
  </div>
  
  <script>
    let eventSource = null;
    let pendingOperation = null;
    
    function showConfirmModal(operation) {
      pendingOperation = operation;
      const bus = document.getElementById('bus').value;
      const address = document.getElementById('address').value;
      const register = document.getElementById('register').value;
      const data = document.getElementById('data').value;
      const length = document.getElementById('length').value;
      
      // Populate modal
      document.getElementById('modalOperation').textContent = operation.replace(/_/g, ' ').toUpperCase();
      document.getElementById('modalBus').textContent = bus;
      document.getElementById('modalAddress').textContent = address;
      document.getElementById('modalRegister').textContent = register;
      document.getElementById('modalData').textContent = data;
      document.getElementById('modalLength').textContent = length;
      
      // Show/hide relevant fields based on operation
      const modalRegisterP = document.getElementById('modalRegisterP');
      const modalDataP = document.getElementById('modalDataP');
      const modalLengthP = document.getElementById('modalLengthP');
      
      if (operation === 'scan') {
        modalRegisterP.style.display = 'none';
        modalDataP.style.display = 'none';
        modalLengthP.style.display = 'none';
      } else if (operation.includes('write')) {
        modalRegisterP.style.display = operation.includes('data') || operation.includes('block') ? 'block' : 'none';
        modalDataP.style.display = 'block';
        modalLengthP.style.display = 'none';
      } else if (operation.includes('read')) {
        modalRegisterP.style.display = operation.includes('data') || operation.includes('block') ? 'block' : 'none';
        modalDataP.style.display = 'none';
        modalLengthP.style.display = operation.includes('block') ? 'block' : 'none';
      }
      
      document.getElementById('confirmModal').style.display = 'block';
    }
    
    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
      pendingOperation = null;
    }
    
    function confirmAndRun() {
      closeModal();
      if (pendingOperation) {
        executeOperation(pendingOperation);
      }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('confirmModal');
      if (event.target === modal) {
        closeModal();
      }
    }
    
    function executeOperation(operation) {
      const bus = document.getElementById('bus').value;
      const address = parseInt(document.getElementById('address').value, 16);
      const register = parseInt(document.getElementById('register').value, 16);
      const data = document.getElementById('data').value;
      const length = document.getElementById('length').value;
      
      // Close existing connection
      if (eventSource) {
        eventSource.close();
      }
      
      // Build URL with parameters
      const params = new URLSearchParams({
        operation: operation,
        bus: bus,
        address: address,
        register: register,
        data: data,
        length: length
      });
      
      const url = `/run-custom-i2c?${params.toString()}`;
      
      // Add operation to output
      appendOutput(`\n>>> Executing: ${operation}\n`);
      appendOutput(`    Bus: ${bus}, Address: 0x${address.toString(16).toUpperCase()}\n`);
      
      // Create EventSource for streaming
      eventSource = new EventSource(url);
      
      eventSource.onmessage = function(event) {
        appendOutput(event.data + '\n');
      };
      
      eventSource.onerror = function() {
        eventSource.close();
        appendOutput('\n--- Operation completed ---\n');
      };
    }
    
    function appendOutput(text) {
      const output = document.getElementById('i2cOutput');
      output.textContent += text;
      output.scrollTop = output.scrollHeight;
    }
    
    function clearOutput() {
      document.getElementById('i2cOutput').textContent = 'Output cleared.\n';
    }
    
    async function cleanupI2C() {
      try {
        const response = await fetch('/cleanup-custom', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ protocol: 'i2c' })
        });
        const data = await response.json();
        appendOutput(`\n${data.result || data.error}\n`);
      } catch (error) {
        appendOutput(`\nError during cleanup: ${error}\n`);
      }
    }
  </script>
</body>
</html>
