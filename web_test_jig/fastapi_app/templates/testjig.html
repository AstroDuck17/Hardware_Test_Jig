<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Test Jig Runner</title>
  <link rel="stylesheet" href="../static/style.css">
  <style>
    /* Fixed viewport layout */
    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
      -moz-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    body {
      display: flex;
      flex-direction: column;
      background-color: #121212;
      color: #ffffff;
    }
    
    /* Dark theme and violet buttons */
    .container {
      background-color: #121212;
      color: #ffffff;
      margin: 0;
      text-align: center;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      font-size: 1.05rem;
    }
    /* Updated styles for the device buttons with violet shade */
    .device-button {
      margin: 3px;
      padding: 10px 18px;
      cursor: pointer;
      background: linear-gradient(135deg, #8a2be2, #da70d6);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 15px;
      font-family: 'Helvetica', sans-serif;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .device-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.4);
    }
    .device-button.active {
      background: linear-gradient(135deg, #6a0dad, #8a2be2);
      border: 2px solid gold;
      transform: scale(1.03);
      box-shadow: 0 6px 10px rgba(0,0,0,0.5);
    }
    /* New styles for the pin connections table */
    .pin-table {
      margin: 10px auto;
      border-collapse: collapse;
      width: 95%;
      font-size: 0.9rem;
    }
    .pin-table th,
    .pin-table td {
      border: 1px solid #555;
      padding: 7px 9px;
      text-align: center;
    }
    /* New CSS for the Run and Stop Test buttons */
    .run-test-button {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      padding: 10px 20px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 3px;
    }
    .run-test-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.4);
    }
    .run-test-button:active {
      transform: translateY(0);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    /* Updated main layout styles - Fixed height layout */
    #main-layout {
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      width: 100%;
      height: 100%;
      margin: 0;
      gap: 8px;
      padding: 8px;
      box-sizing: border-box;
      overflow: hidden;
    }
    /* Left section: protocol selection */
    #left-section {
      flex: 0 0 18%;
      display: flex;
      flex-direction: column;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.3);
      background-color: #1e1e1e;
      border-radius: 8px;
      overflow-y: auto;
    }
    /* Middle section: test output will span the area in the middle */
    #middle-section {
      flex: 1 1 48%;
      display: flex;
      flex-direction: column;
      padding: 10px;
      text-align: center;
      background-color: #1e1e1e;
      border-radius: 8px;
      overflow: hidden;
    }
    /* Right section: device selection and pin connections */
    #right-section {
      flex: 0 0 22%;
      display: flex;
      flex-direction: column;
      padding: 8px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.3);
      background-color: #1e1e1e;
      border-radius: 8px;
      box-sizing: border-box;
      overflow: hidden;
      gap: 8px;
    }
    #device-selection-container,
    #pin-connection-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #device-selection-container {
      flex: 0 0 auto;
      min-height: 120px;
    }
    #pin-connection-container {
      flex: 1 1 auto;
      overflow-y: auto;
      background-color: #2a2a2a;
      border-radius: 6px;
      padding: 8px;
    }
    #pin-connection-container h2 {
      margin-top: 0;
      font-size: 1.15rem;
    }
    #pinOutput {
      overflow-y: auto;
      flex: 1;
    }
    #pinOutput table {
      font-size: 0.9rem;
    }
    /* Flex container to place Run Test and Stop Test buttons side by side */
    .test-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex: 0 0 auto;
      margin-top: 8px;
    }
    /* New scrollable output box for test results */
    #testOutput {
      flex: 1;
      overflow-y: auto;
      margin: 0;
      background: #2e2e2e;
      color: #EEEEEE;
      padding: 1rem;
      border-radius: 4px;
      border: 1px solid #555;
      font-size: 1rem;
    }
    /* Navigation bar styles - compact version */
    .nav-bar {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin: 0;
      padding-right: 24px;
    }
    .nav-btn {
      padding: 8px 24px;
      font-size: 0.95rem;
      border: 1.5px solid #a084e8;
      border-radius: 999px;
      background: rgba(40, 30, 60, 0.55);
      color: #e7e0fa;
      font-family: 'Segoe UI', 'Helvetica', sans-serif;
      box-shadow: 0 2px 12px 0 rgba(138,43,226,0.10), 0 1px 0 #8a2be2 inset;
      cursor: pointer;
      transition: 
        background 0.18s, 
        color 0.18s, 
        border 0.18s, 
        box-shadow 0.18s, 
        transform 0.18s;
      backdrop-filter: blur(2.5px);
      outline: none;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .nav-btn:hover, .nav-btn:focus {
      background: linear-gradient(90deg, #8a2be2 0%, #da70d6 100%);
      color: #fff;
      border: 1.5px solid #fff;
      box-shadow: 0 4px 16px rgba(138,43,226,0.18), 0 1px 0 #fff inset;
      transform: translateY(-1px) scale(1.03);
    }
    /* Compact header */
    header {
      flex: 0 0 auto;
      padding: 0.5rem 0;
    }
    
    .header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 0 24px 0 12px;
      margin-bottom: 0;
    }
    .header-logo {
      height: 40px;
      width: auto;
      margin-right: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(138,43,226,0.10);
      background: #232526;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .header-logo:hover {
      transform: scale(1.05);
    }
    .header-title {
      cursor: pointer;
      transition: color 0.2s;
      font-size: 1.5rem;
      margin: 0;
    }
    .header-title:hover {
      color: #da70d6;
    }
    
    /* Compact footer */
    footer {
      flex: 0 0 auto;
      padding: 0.4rem;
      font-size: 0.85rem;
    }
    /* Add style for device dropdown */
    .device-dropdown {
      width: 90%;
      padding: 10px;
      font-size: 1.05rem;
      border-radius: 8px;
      border: 1.5px solid #8A2BE2;
      background: #232526;
      color: #fff;
      margin: 8px auto 0 auto;
      display: block;
      font-family: 'Segoe UI', 'Helvetica', sans-serif;
      transition: border 0.2s;
    }
    .device-dropdown:focus {
      border: 1.5px solid #da70d6;
      outline: none;
    }
    
    /* Protocol selection adjustments */
    #protocol-selection {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      width: 100%;
    }
    
    #protocol-selection .protocol-bubble {
      flex-shrink: 0;
    }
    
    #left-section h2,
    #device-selection-container h2 {
      font-size: 1.25rem;
      margin: 0 0 10px 0;
    }
    /* Output header with action buttons */
    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      flex: 0 0 auto;
    }
    .output-header h2 {
      font-size: 1.4rem;
    }
    .output-actions {
      display: flex;
      gap: 8px;
    }
    .icon-button {
      background: transparent;
      border: 1px solid #8A2BE2;
      border-radius: 6px;
      color: #8A2BE2;
      cursor: pointer;
      padding: 6px 10px;
      font-size: 1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-button:hover {
      background: #8A2BE2;
      color: white;
      transform: scale(1.05);
    }
    /* Toggle button styles */
    .toggle-test-button {
      background: linear-gradient(135deg, #28a745, #20c997);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      padding: 10px 28px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      margin: 3px;
      min-width: 140px;
    }
    .toggle-test-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.4);
    }
    .toggle-test-button.running {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
    }
    .toggle-test-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Settings info display */
    .settings-info {
      background-color: #2a2a2a;
      border-radius: 6px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.8rem;
      border-left: 4px solid #8A2BE2;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.3s, max-height 0.3s;
    }
    .settings-info.visible {
      opacity: 1;
      max-height: 200px;
    }
    .settings-info h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      color: #8A2BE2;
    }
    .settings-info p {
      margin: 0.3rem 0;
      font-size: 0.9rem;
      color: #cccccc;
    }
    .settings-info strong {
      color: #ffffff;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-flex">
      <img src="../static/city.png" alt="City" class="header-logo" onclick="location.href='./homepage.html'" />
      <h1 style="flex:1; text-align:left; margin:0;" class="header-title" onclick="location.href='./homepage.html'">Test Jig Runner</h1>
      <div class="nav-bar">
        <button onclick="location.href='./rs485.html'" class="nav-btn">RS485</button>
      </div>
    </div>
  </header>
  <!-- New main layout container -->
  <main class="container">
    <div id="main-layout">
      <!-- Left Section: Protocol Selection -->
      <div id="left-section">
          <h2>Select Protocol</h2>
          <div id="protocol-selection">
            <button type="button" class="protocol-bubble" data-protocol="i2c">I2C</button>
            <button type="button" class="protocol-bubble" data-protocol="spi">SPI</button>
            <button type="button" class="protocol-bubble" data-protocol="uart">UART</button>
            <button type="button" class="protocol-bubble" data-protocol="pwm">PWM</button>
            <!-- New protocol buttons -->
            <button type="button" class="protocol-bubble" data-protocol="adc">ADC</button>
            <button type="button" class="protocol-bubble" data-protocol="gpio">GPIO</button>
          </div>
      </div>
      <!-- Middle Section: Test Output -->
      <div id="middle-section">
          <div class="output-header">
            <h2 style="margin: 0;">Test Output</h2>
            <div class="output-actions">
              <button class="icon-button" onclick="clearOutput()" title="Clear Output">
                <span>üóëÔ∏è</span>
              </button>
              <button class="icon-button" onclick="downloadLog()" title="Download Log">
                <span>üíæ</span>
              </button>
            </div>
          </div>
          <!-- Settings Info Display -->
          <div id="settingsInfo" class="settings-info">
            <h3>Current Configuration</h3>
            <p><strong>Protocol:</strong> <span id="displayProtocol">-</span> | <strong>Device:</strong> <span id="displayDevice">-</span></p>
          </div>
          <pre id="testOutput"></pre>
          <div class="test-buttons">
            <button id="toggleTestButton" class="toggle-test-button" onclick="toggleTest()">Run Test</button>
          </div>
      </div>
      <!-- Right Section: Top: Device Selection, Bottom: Pin Connections -->
      <div id="right-section">
          <div id="device-selection-container">
              <h2>Select Device</h2>
              <!-- Dropdown for device selection -->
              <select id="device-dropdown" class="device-dropdown"></select>
          </div>
          <div id="pin-connection-container">
              <h2>Pin Connections:</h2>
              <div id="pinOutput" class="pin-display" style="display: none;"></div>
          </div>
      </div>
    </div>
  </main>
  <footer>
    <p>&copy; 2025 Test Jig Runner</p>
  </footer>
  <script>
    // Set default selected protocol and device to empty
    let selectedProtocol = "";
    let selectedDevice = "";
    let isTestRunning = false;

    document.querySelectorAll('.protocol-bubble').forEach(button => {
      button.addEventListener('click', function() {
        selectedProtocol = this.getAttribute('data-protocol');
        // Clear existing active styling for protocol bubbles
        document.querySelectorAll('.protocol-bubble').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        updateDevices();
      });
    });

    const deviceOptions = {
      "i2c": [
        { value: "bh1750", label: "BH1750" },
        { value: "oled", label: "OLED" },
        { value: "mlx90614", label: "MLX90614" }
      ],
      "spi": [
        { value: "sd-card", label: "SD Card Module" },
        { value: "oled", label: "SPI OLED" }
      ],
      "uart": [
        { value: "pm sensor", label: "PM Sensor" }
      ],
      "pwm": [
        { value: "led-fading", label: "LED(Fading)" },
        { value: "servo motor", label: "Servo Motor" },
        { value: "rgb led", label: "RGB LED" }
      ],
      // New device options for ADC and GPIO protocols
      "adc": [
        { value: "pot", label: "Potentiometer" },
        { value: "tds", label: "TDS" },
        { value: "ldr", label: "LDR" }
      ],
      "gpio": [
        { value: "led", label: "LED" },
        { value: "button", label: "BUTTON" },
        { value: "ultrasonic sensor", label: "Ultrasonic Sensor" },
        { value: "dht11", label: "DHT11" },
        { value: "ds18b20", label: "DS18B20" }
      ]
    };

    function updateDevices() {
      const dropdown = document.getElementById("device-dropdown");
      dropdown.innerHTML = "";
      selectedDevice = "";
      if (selectedProtocol && deviceOptions[selectedProtocol]) {
        deviceOptions[selectedProtocol].forEach(opt => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          dropdown.appendChild(option);
        });
        // Select first device by default and trigger change
        if (deviceOptions[selectedProtocol].length > 0) {
          dropdown.selectedIndex = 0;
          selectedDevice = dropdown.value;
          fetchPinConnection();
        }
      } else {
        document.getElementById('pinOutput').innerHTML = "";
        document.getElementById('pinOutput').style.display = "none";
      }
    }

    // Listen for dropdown changes
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("device-dropdown").addEventListener("change", function() {
        selectedDevice = this.value;
        fetchPinConnection();
      });
    });

    function fetchPinConnection() {
      if (!selectedProtocol || !selectedDevice) {
        document.getElementById('pinOutput').style.display = "none";
        return;
      }
      let tableHTML = "";
      if (selectedProtocol === "i2c") {
        let header = "I2C port";
        let rows = [
          { pin: "VCC", port: "Rpi VCC" },
          { pin: "GND", port: "Rpi GND" },
          { pin: "SCL", port: "PIN 1 (I2C PORT)" },
          { pin: "SDA", port: "PIN 2 (I2C PORT)" }
        ];
        tableHTML = generateTable(header, rows);
      } else if (selectedProtocol === "spi") {
        let header = "SPI port";
        let rows = [];
        if (selectedDevice === "sd-card") {
          rows = [
            { pin: "VCC", port: "Rpi VCC" },
            { pin: "GND", port: "Rpi GND" },
            { pin: "MISO", port: "PIN X (SPI PORT)" },
            { pin: "MOSI", port: "PIN Y (SPI PORT)" },
            { pin: "SCK", port: "PIN Z (SPI PORT)" },
            { pin: "CS", port: "PIN W (SPI PORT)" }
          ];
        } else if (selectedDevice === "oled") {
          rows = [
            { pin: "VCC", port: "Rpi VCC" },
            { pin: "GND", port: "Rpi GND" },
            { pin: "SCK", port: "PIN 3 (SPI PORT)" },
            { pin: "SDA", port: "PIN 2 (SPI PORT)" },
            { pin: "RES", port: "PIN 6 (SPI PORT)" },
            { pin: "DC", port: "PIN 5 (SPI PORT)" },
            { pin: "CS", port: "PIN 4 (SPI PORT)" }
          ];
        }
        tableHTML = generateTable(header, rows);
      } else if (selectedProtocol === "uart") {
        let header = "UART port";
        let rows = [
          { pin: "VCC", port: "Rpi VCC" },
          { pin: "GND", port: "Rpi GND" },
          { pin: "RX",  port: "PIN 1 (UART PORT)" },
          { pin: "TX",  port: "PIN 2 (UART PORT)" }
        ];
        tableHTML = generateTable(header, rows);
      } else if (selectedProtocol === "pwm") {
        let header = "PWM port";
        let rows = [];
        if (selectedDevice === "led-fading") {
          rows = [
            { pin: "LED", port: "PIN 1 (PWM PORT)" },
            { pin: "GND", port: "Rpi GND" }
          ];
        } else if (selectedDevice === "servo motor") {
          rows = [
            { pin: "VCC",    port: "Rpi VCC" },
            { pin: "GND",    port: "Rpi GND" },
            { pin: "Signal", port: "PIN 4 (PWM PORT)" }
          ];
        } else if (selectedDevice === "rgb led") {
          rows = [
            { pin: "R",    port: "PIN 1 (PWM PORT)" },
            { pin: "B",    port: "PIN 2 (PWM PORT)" },
            { pin: "G",    port: "PIN 3 (PWM PORT)" },
            { pin: "GND",  port: "Rpi GND" }
          ];
        }
        tableHTML = generateTable(header, rows);
      } else if (selectedProtocol === "adc") {
        // ADC devices: same table for all options
        let header = "ADC port";
        let rows = [
          { pin: "VCC", port: "Rpi VCC" },
          { pin: "GND", port: "Rpi GND" },
          { pin: "DATA Pin", port: "PIN 1 (ADC PORT)" }
        ];
        tableHTML = generateTable(header, rows);
      } else if (selectedProtocol === "gpio") {
        let header = "GPIO Port";
        let rows = [];
        if (selectedDevice === "led") {
          rows = [
            { pin: "LED(+)", port: "PIN 2 (GPIO PORT)" },
            { pin: "GND", port: "Rpi GND" }
          ];
        } else if (selectedDevice === "button") {
          rows = [
            { pin: "Terminal 1", port: "PIN 3 (GPIO PORT)" },
            { pin: "Terminal 2", port: "Rpi GND" }
          ];
        } else if (selectedDevice === "dht11") {
          rows = [
            { pin: "VCC", port: "Rpi VCC" },
            { pin: "GND", port: "Rpi GND" },
            { pin: "DATA", port: "PIN 4 (GPIO PORT)" }
          ];
        } else if (selectedDevice === "ultrasonic sensor") {
          rows = [
            { pin: "VCC", port: "Rpi VCC" },
            { pin: "GND", port: "Rpi GND" },
            { pin: "Trigger", port: "PIN 6 (GPIO PORT)" },
            { pin: "Echo", port: "PIN 5 (GPIO PORT)" }
          ];
        } else if (selectedDevice === "ds18b20") {
          rows = [
            { pin: "VCC", port: "Rpi VCC" },
            { pin: "GND", port: "Rpi GND" },
            { pin: "Signal", port: "PIN 1 (GPIO PORT)" }
          ];
        }
        tableHTML = generateTable(header, rows);
      }
      document.getElementById('pinOutput').innerHTML = tableHTML;
      document.getElementById('pinOutput').style.display = "block";
    }

    function generateTable(header, rows) {
      let tableHTML = `<table class="pin-table">
        <thead>
          <tr><th>Pin</th><th>${header}</th></tr>
        </thead>
        <tbody>`;
      rows.forEach(row => {
        tableHTML += `<tr><td>${row.pin}</td><td>${row.port}</td></tr>`;
      });
      tableHTML += `</tbody></table>`;
      return tableHTML;
    }

    function toggleTest() {
      if (isTestRunning) {
        stopTest();
      } else {
        runTest(selectedProtocol, selectedDevice);
      }
    }

    function runTest(protocol, device) {
        if (!protocol || !device) {
          alert("Please select a protocol and device first!");
          return;
        }
        
        // Update configuration display
        updateSettingsDisplay(protocol, device);
        
        // Update button state
        isTestRunning = true;
        const button = document.getElementById("toggleTestButton");
        button.textContent = "Stop Test";
        button.classList.add("running");
        
        // Use EventSource to stream test output
        document.getElementById("testOutput").innerHTML = "";
        var eventSource = new EventSource(`/run-test/${encodeURIComponent(protocol)}/${encodeURIComponent(device)}`);
        eventSource.onmessage = function(event) {
            console.log("Test result:", event.data);
            // Append output with a line break
            let output = document.getElementById("testOutput");
            output.innerHTML += event.data + "<br>";
            // Automatically scroll to bottom as new results appear
            output.scrollTop = output.scrollHeight;
        };
        eventSource.onerror = function(err) {
            console.error("EventSource error:", err);
            eventSource.close();
            // Reset button state on error
            isTestRunning = false;
            button.textContent = "Run Test";
            button.classList.remove("running");
        };
        window.currentEventSource = eventSource;
    }

    function stopTest() {
        if (window.currentEventSource) {
            fetch('/stop-test', { method: "POST" })
              .then(response => response.json())
              .then(data => {
                  console.log(data);
              })
              .catch(err => console.error(err));
            window.currentEventSource.close();
            window.currentEventSource = null;
        }
        
        // Reset button state
        isTestRunning = false;
        const button = document.getElementById("toggleTestButton");
        button.textContent = "Run Test";
        button.classList.remove("running");
    }
    
    // Update settings display
    function updateSettingsDisplay(protocol, device) {
      document.getElementById('displayProtocol').textContent = protocol ? protocol.toUpperCase() : '-';
      document.getElementById('displayDevice').textContent = device || '-';
      
      // Show the settings info
      const settingsInfo = document.getElementById('settingsInfo');
      settingsInfo.classList.add('visible');
    }

    function clearOutput() {
      document.getElementById("testOutput").innerHTML = "";
    }
    
    // New downloadLog() function
    function downloadLog() {
      const outputText = document.getElementById("testOutput").innerText;
      const blob = new Blob([outputText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "test_output_log.txt";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>